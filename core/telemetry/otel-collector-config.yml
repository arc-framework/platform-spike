receivers:
  otlp: # Receives data on ports 4317 (gRPC) and 4318 (HTTP)
    protocols:
      grpc: # Explicitly set the endpoint to listen on all network interfaces.
        endpoint: 0.0.0.0:4317
      http: # Do the same for the HTTP receiver for consistency.
        endpoint: 0.0.0.0:4318

processors:
  batch: # Batches data for efficiency
  # This processor is crucial for linking logs with traces. It uses OTTL
  # to copy the trace_id and span_id from the log's context into its attributes.
  transform:
    log_statements:
      - context: log
        statements:
          - set(attributes["trace_id"], trace_id)
          - set(attributes["span_id"], span_id)

exporters:
  # Exporter 1: Send logs to Loki via OTLP
  # The 'loki' exporter is no longer in the default contrib image.
  # We use the standard otlphttp exporter, as Loki supports OTLP natively.
  otlphttp/loki:
    endpoint: "http://loki:3100/otlp"
    # OTLP uses HTTP headers for auth, not a specific config block.
    # Headers can be set here if needed, e.g., for multi-tenancy.
    # headers:
    #   "X-Scope-OrgID": "my-tenant"

  # Exporter 2: Send traces to Jaeger via OTLP
  # The dedicated 'jaeger' exporter is deprecated. Jaeger natively supports OTLP.
  otlp/jaeger:
    endpoint: jaeger:4317 # Jaeger's OTLP gRPC endpoint
    tls:
      insecure: true

  # Exporter 4: Make metrics available for Prometheus to scrape
  prometheus:
    endpoint: "0.0.0.0:8889" # An internal port for Prometheus to scrape

connectors:
  # The spanmetrics connector generates RED metrics (Rate, Error, Duration) from trace spans.
  spanmetrics:
    # The latency_histogram_buckets key is deprecated. Use the 'histogram' block instead.
    histogram:
      unit: ms # Specify the unit for latency measurements.
      # For explicit boundaries, the buckets must be defined under the 'explicit' key.
      explicit:
        # The values are numbers corresponding to the 'unit' defined above (ms).
        buckets: [100, 250, 500, 1000, 2500, 5000, 10000]
    # We can add dimensions (attributes) to the metrics for more detailed analysis.
    dimensions:
      - name: http.method
      - name: http.status_code

extensions:
  health_check:
    # The health check extension is available on all interfaces by default.

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [batch]
      # Traces are sent to Jaeger for storage and to the spanmetrics connector to generate metrics.
      exporters: [otlp/jaeger, spanmetrics]

    metrics:
      receivers: [otlp]
      processors: [batch]
      exporters: [prometheus]

    # This is a new pipeline dedicated to handling the metrics generated by the spanmetrics connector.
    metrics/spanmetrics:
      receivers: [spanmetrics] # It receives data FROM the connector.
      processors: [batch]
      exporters: [prometheus] # It exports the metrics to Prometheus.

    logs:
      receivers: [otlp]
      processors: [batch, transform]
      exporters: [otlphttp/loki]

  extensions: [health_check]

  telemetry:
    logs:
      level: "info"
