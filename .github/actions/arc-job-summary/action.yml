name: 'A.R.C. Job Summary'
description: 'Generate formatted job summaries with visual indicators for A.R.C. workflows'

inputs:
  title:
    description: 'Summary title'
    required: false
    default: 'A.R.C. CI/CD Results'
  status:
    description: 'Overall status (success, failure, warning)'
    required: true
  results-json:
    description: 'Path to JSON file with detailed results'
    required: false
    default: ''
  summary-type:
    description: 'Type of summary (build, security, validation, deployment)'
    required: false
    default: 'build'
  additional-content:
    description: 'Additional markdown content to append'
    required: false
    default: ''

outputs:
  summary-path:
    description: 'Path to the generated summary file'
    value: ${{ steps.generate.outputs.summary-path }}

runs:
  using: 'composite'
  steps:
    - name: Generate summary
      id: generate
      shell: bash
      run: |
        # Status emoji mapping
        case "${{ inputs.status }}" in
          success) STATUS_EMOJI="âœ…" ;;
          failure) STATUS_EMOJI="âŒ" ;;
          warning) STATUS_EMOJI="âš ï¸" ;;
          *) STATUS_EMOJI="ðŸ”„" ;;
        esac

        # Generate header
        echo "## $STATUS_EMOJI ${{ inputs.title }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Add timestamp
        echo "**Run:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** [\`${GITHUB_SHA:0:7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
        echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Process results JSON if provided
        if [ -n "${{ inputs.results-json }}" ] && [ -f "${{ inputs.results-json }}" ]; then
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Parse based on summary type
          case "${{ inputs.summary-type }}" in
            build)
              echo "| Service | Status | Duration | Size |" >> $GITHUB_STEP_SUMMARY
              echo "|---------|--------|----------|------|" >> $GITHUB_STEP_SUMMARY
              jq -r '.builds[]? | "| \(.service) | \(if .status == "success" then "âœ…" else "âŒ" end) | \(.duration // "-") | \(.size // "-") |"' "${{ inputs.results-json }}" >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "| No build data | - | - | - |" >> $GITHUB_STEP_SUMMARY
              ;;
            security)
              echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
              echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
              jq -r '.vulnerabilities? | to_entries[] | "| \(.key) | \(.value) |"' "${{ inputs.results-json }}" >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "| No vulnerabilities | 0 |" >> $GITHUB_STEP_SUMMARY
              ;;
            validation)
              echo "| Check | Status | Details |" >> $GITHUB_STEP_SUMMARY
              echo "|-------|--------|---------|" >> $GITHUB_STEP_SUMMARY
              jq -r '.checks[]? | "| \(.name) | \(if .passed then "âœ…" else "âŒ" end) | \(.details // "-") |"' "${{ inputs.results-json }}" >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "| No checks | - | - |" >> $GITHUB_STEP_SUMMARY
              ;;
            deployment)
              echo "| Service | Environment | Status | URL |" >> $GITHUB_STEP_SUMMARY
              echo "|---------|-------------|--------|-----|" >> $GITHUB_STEP_SUMMARY
              jq -r '.deployments[]? | "| \(.service) | \(.env) | \(if .status == "success" then "âœ…" else "âŒ" end) | \(.url // "-") |"' "${{ inputs.results-json }}" >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "| No deployments | - | - | - |" >> $GITHUB_STEP_SUMMARY
              ;;
          esac
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        # Add additional content if provided
        if [ -n "${{ inputs.additional-content }}" ]; then
          echo "${{ inputs.additional-content }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        # Add footer
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "_Generated by [A.R.C. CI/CD](https://github.com/arc-framework/platform-spike)_" >> $GITHUB_STEP_SUMMARY

        echo "summary-path=$GITHUB_STEP_SUMMARY" >> $GITHUB_OUTPUT
