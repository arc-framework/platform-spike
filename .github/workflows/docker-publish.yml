name: Publish A.R.C. Images

on:
  workflow_dispatch: # Button to run manually
  # schedule:
  #   - cron: '0 0 1 * *' # Auto-update monthly

env:
  REGISTRY: ghcr.io
  NAMESPACE: arc-framework
  VERSION: v1.0.0

jobs:
  publish-vendor-images:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # âš¡ Required for GHCR

    steps:
      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Mirror Vendor Images
        run: |
          # The Verified Master List
          declare -A IMAGES=(
            # --- Gateway & Auth ---
            ["traefik:latest"]="arc-heimdall-gateway"
            ["unleashorg/unleash-server:latest"]="arc-mystique-flags"
            ["oryd/kratos:latest"]="arc-deckard-identity"
            ["infisical/infisical:latest"]="arc-fury-vault"
            
            # --- Data & Messaging ---
            ["apachepulsar/pulsar:latest"]="arc-strange-stream"
            ["nats:alpine"]="arc-flash-pulse"      # ðŸ‘ˆ Saved 100MB here
            ["postgres:17-alpine"]="arc-oracle-sql" # ðŸ‘ˆ Locked to 17 + Alpine
            ["redis:alpine"]="arc-sonic-cache"      # ðŸ‘ˆ Speed demon
            ["qdrant/qdrant:latest"]="arc-cerebro-vector"
            ["minio/minio:latest"]="arc-holocron-storage"
            
            # --- Observability ---
            ["otel/opentelemetry-collector:latest"]="arc-widow-otel"
            ["prom/prometheus:latest"]="arc-mercy-metrics"
            ["grafana/loki:latest"]="arc-watson-logs"
            ["grafana/tempo:latest"]="arc-rorschach-traces"
            ["grafana/grafana:latest"]="arc-friday-viz"
            ["grafana/promtail:latest"]="arc-hermes-shipper"
            
            # --- Resilience ---
            ["ghcr.io/chaos-mesh/chaos-mesh:latest"]="arc-terminator-chaos"
            
            # --- Voice & Media ---
            ["livekit/livekit-server:latest"]="arc-daredevil-voice"
            ["livekit/ingress:latest"]="arc-sentry-ingress"
            ["livekit/egress:latest"]="arc-echo-egress"
            
            # --- Logic & Time ---
            ["temporalio/auto-setup:latest"]="arc-kang-flow"
            ["dkron/dkron:latest"]="arc-doc-time"
            
            # --- Platform Tools ---
            ["roadiehq/community-backstage-image:latest"]="arc-architect-portal"
            ["mailhog/mailhog:latest"]="arc-hedwig-mailer"
          )

          for source in "${!IMAGES[@]}"; do
            target="${IMAGES[$source]}"
            full_target="${{ env.REGISTRY }}/${{ env.NAMESPACE }}/$target"
            
            echo "ðŸš€ Processing: $target"
            echo "   Source: $source"

            # 1. Cloud Copy Version Tag
            docker buildx imagetools create \
              -t "$full_target:${{ env.VERSION }}" \
              "$source"

            # 2. Cloud Copy Latest Tag
            docker buildx imagetools create \
              -t "$full_target:latest" \
              "$source"
              
            echo "   âœ… Done."
            # Sleep to prevent rate limiting from Docker Hub
            sleep 2
          done
