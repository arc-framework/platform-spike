name: Publish A.R.C. Images

on:
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  NAMESPACE: arc-framework # ðŸ‘ˆ Your Org
  VERSION: v1.0.0
  # OCI Labels
  SOURCE_URL: 'https://github.com/arc-framework/arc-platform'
  LICENSE: 'Apache-2.0'

jobs:
  publish-vendor-images:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Mirror & Label Vendor Images
        run: |
          # ------------------------------------------------------------------
          # ðŸ› ï¸ Helper Function: Build, Tag, Label, and Push
          # ------------------------------------------------------------------
          process_group() {
            local group_name="$1"
            # We use 'nameref' to pass the array by name (requires bash 4.3+)
            local -n images=$2
            
            echo "-----------------------------------------------------"
            echo "ðŸ“¦ Processing Group: $group_name"
            echo "-----------------------------------------------------"

            for source in "${!images[@]}"; do
              target="${images[$source]}"
              full_target="${{ env.REGISTRY }}/${{ env.NAMESPACE }}/$target"
              
              echo "   ðŸš€ Mirroring: $source -> $target"

              # Multi-arch build (amd64 + arm64) to ensure compatibility
              # We inject the labels dynamically using --label
              docker buildx build \
                --platform linux/amd64,linux/arm64 \
                --tag "$full_target:${{ env.VERSION }}" \
                --tag "$full_target:latest" \
                --label "org.opencontainers.image.source=${{ env.SOURCE_URL }}" \
                --label "org.opencontainers.image.description=A.R.C. Vendor Mirror: $group_name - $source" \
                --label "org.opencontainers.image.licenses=${{ env.LICENSE }}" \
                --output type=image,push=true \
                - <<EOF
          FROM $source
          EOF
              
              echo "      âœ… Pushed $target"
            done
          }

          # ------------------------------------------------------------------
          # 1. ðŸ›¡ï¸ Gateway & Identity
          # ------------------------------------------------------------------
          declare -A GROUP_GATEWAY=(
            ["traefik:latest"]="arc-heimdall-gateway"
            ["unleashorg/unleash-server:latest"]="arc-mystique-flags"
            ["oryd/kratos:latest"]="arc-deckard-identity"
            ["infisical/infisical:latest"]="arc-fury-vault"
          )
          # process_group "Gateway & Identity" GROUP_GATEWAY

          # ------------------------------------------------------------------
          # 2. ðŸ’¾ Data & Messaging
          # ------------------------------------------------------------------
          declare -A GROUP_DATA=(
            ["apachepulsar/pulsar:latest"]="arc-strange-stream"
            ["nats:alpine"]="arc-flash-pulse"
            ["postgres:17-alpine"]="arc-oracle-sql"
            ["redis:alpine"]="arc-sonic-cache"
            ["qdrant/qdrant:latest"]="arc-cerebro-vector"
            ["minio/minio:latest"]="arc-holocron-storage"
          )
          process_group "Data & Messaging" GROUP_DATA

          # ------------------------------------------------------------------
          # 3. ðŸ”­ Observability
          # ------------------------------------------------------------------
          declare -A GROUP_OBSERVABILITY=(
            ["otel/opentelemetry-collector:latest"]="arc-widow-otel"
            ["prom/prometheus:latest"]="arc-house-metrics"
            ["grafana/loki:latest"]="arc-watson-logs"
            ["jaegertracing/all-in-one:latest"]="arc-columbo-traces"
            ["grafana/grafana:latest"]="arc-friday-viz"
            ["grafana/promtail:latest"]="arc-hermes-shipper"
          )
          # process_group "Observability" GROUP_OBSERVABILITY

          # ------------------------------------------------------------------
          # 4. âš¡ Resilience & Tools
          # ------------------------------------------------------------------
          declare -A GROUP_TOOLS=(
            ["ghcr.io/chaos-mesh/chaos-mesh:latest"]="arc-terminator-chaos"
            ["roadiehq/community-backstage-image:latest"]="arc-architect-portal"
            ["mailhog/mailhog:latest"]="arc-hedwig-mailer"
          )
          # process_group "Resilience & Tools" GROUP_TOOLS

          # ------------------------------------------------------------------
          # 5. ðŸ—£ï¸ Voice & Media
          # ------------------------------------------------------------------
          declare -A GROUP_VOICE=(
            ["livekit/livekit-server:latest"]="arc-daredevil-voice"
            ["livekit/ingress:latest"]="arc-sentry-ingress"
            ["livekit/egress:latest"]="arc-echo-egress"
          )
          # process_group "Voice & Media" GROUP_VOICE

          # ------------------------------------------------------------------
          # 6. ðŸ§  Logic & Orchestration
          # ------------------------------------------------------------------
          declare -A GROUP_LOGIC=(
             ["temporalio/auto-setup:latest"]="arc-kang-flow"
             ["dkron/dkron:latest"]="arc-doc-time"
          )
          # process_group "Logic & Orchestration" GROUP_LOGIC
