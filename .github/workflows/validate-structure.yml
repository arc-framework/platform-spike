# ==============================================================================
# A.R.C. Platform - Structure Validation Workflow
# ==============================================================================
# Task: T057
# Purpose: Validate directory structure, SERVICE.MD, and Dockerfiles on PRs
#
# Triggers:
#   - Pull requests to main
#   - Push to main (for badge status)
#
# Checks:
#   - Directory structure follows Constitution
#   - SERVICE.MD synchronized with directories
#   - Dockerfiles follow security standards
#   - Docker Compose files are valid
# ==============================================================================

name: Validate Structure

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'core/**'
      - 'plugins/**'
      - 'services/**'
      - '.docker/**'
      - 'deployments/**'
      - 'SERVICE.MD'
      - '**/Dockerfile'
      - 'scripts/validate/**'

  pull_request:
    paths:
      - 'core/**'
      - 'plugins/**'
      - 'services/**'
      - '.docker/**'
      - 'deployments/**'
      - 'SERVICE.MD'
      - '**/Dockerfile'
      - 'scripts/validate/**'

  workflow_dispatch:

jobs:
  # ============================================================================
  # Structure Validation
  # ============================================================================
  validate-structure:
    name: Directory Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate directory structure
        run: python scripts/validate/check-structure.py

      - name: Create summary
        if: always()
        run: |
          echo "## Directory Structure Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          python scripts/validate/check-structure.py --json | jq -r '
            "| Check | Status |",
            "|-------|--------|",
            "| Directories | \(if .valid then "✅ Pass" else "❌ Fail" end) |",
            "| Errors | \(.summary.errors) |",
            "| Warnings | \(.summary.warnings) |"
          ' >> $GITHUB_STEP_SUMMARY || true

  # ============================================================================
  # SERVICE.MD Validation
  # ============================================================================
  validate-registry:
    name: Service Registry
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate SERVICE.MD
        run: python scripts/validate/check-service-registry.py

      - name: Create summary
        if: always()
        run: |
          echo "## SERVICE.MD Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          python scripts/validate/check-service-registry.py --json | jq -r '
            "| Check | Status |",
            "|-------|--------|",
            "| Registry | \(if .valid then "✅ Pass" else "❌ Fail" end) |",
            "| Services Checked | \(.services_checked) |",
            "| Errors | \(.summary.errors) |"
          ' >> $GITHUB_STEP_SUMMARY || true

  # ============================================================================
  # Dockerfile Standards
  # ============================================================================
  validate-dockerfiles:
    name: Dockerfile Standards
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate Dockerfile standards
        run: python scripts/validate/check-dockerfile-standards.py

      - name: Run hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: "**/Dockerfile"
          recursive: true
          config: .hadolint.yaml
          failure-threshold: error

      - name: Create summary
        if: always()
        run: |
          echo "## Dockerfile Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          python scripts/validate/check-dockerfile-standards.py --json | jq -r '
            "| Check | Status |",
            "|-------|--------|",
            "| Standards | \(if .valid then "✅ Pass" else "❌ Fail" end) |",
            "| Dockerfiles | \(.total_dockerfiles) |",
            "| Errors | \(.total_errors) |"
          ' >> $GITHUB_STEP_SUMMARY || true

  # ============================================================================
  # Docker Compose Validation
  # ============================================================================
  validate-compose:
    name: Docker Compose
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate compose files
        run: |
          echo "## Docker Compose Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY

          FAILED=false
          for file in deployments/docker/docker-compose*.yml; do
            if [ -f "$file" ]; then
              if docker compose -f "$file" config > /dev/null 2>&1; then
                echo "| $(basename $file) | ✅ Valid |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| $(basename $file) | ❌ Invalid |" >> $GITHUB_STEP_SUMMARY
                FAILED=true
              fi
            fi
          done

          if [ "$FAILED" = true ]; then
            exit 1
          fi

  # ============================================================================
  # Summary Job
  # ============================================================================
  validation-complete:
    name: Validation Complete
    runs-on: ubuntu-latest
    needs: [validate-structure, validate-registry, validate-dockerfiles, validate-compose]
    if: always()

    steps:
      - name: Check results
        run: |
          if [ "${{ needs.validate-structure.result }}" != "success" ] || \
             [ "${{ needs.validate-registry.result }}" != "success" ] || \
             [ "${{ needs.validate-dockerfiles.result }}" != "success" ] || \
             [ "${{ needs.validate-compose.result }}" != "success" ]; then
            echo "One or more validations failed"
            exit 1
          fi
          echo "All validations passed!"
