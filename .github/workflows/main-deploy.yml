name: Main Deploy

# Orchestration workflow for automated deployment on merge to main
# Builds, scans, and publishes images to GHCR dev registry
#
# Features:
#   - Automatic build and push on merge
#   - SBOM generation for all images
#   - CVE blocking for CRITICAL vulnerabilities
#   - Multi-tag strategy (dev-<sha>, dev-latest)
#   - Comprehensive deployment summaries
#
# Trigger: Push to main branch (after PR merge)

on:
  push:
    branches: [main]
    paths:
      - 'services/**'
      - 'core/**'
      - 'plugins/**'
      - '.docker/**'
      - '**/Dockerfile'
      - '**/requirements*.txt'
      - '**/pyproject.toml'

# Only one deployment at a time
concurrency:
  group: main-deploy
  cancel-in-progress: false  # Don't cancel in-progress deployments

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  # ============================================
  # Job 1: Detect Changed Services
  # ============================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.detect.outputs.services }}
      service-count: ${{ steps.detect.outputs.count }}
      has-changes: ${{ steps.detect.outputs.has-changes }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit for diff

      - name: Detect changed services
        id: detect
        run: |
          # Compare with previous commit
          BASE_SHA="${{ github.event.before }}"
          HEAD_SHA="${{ github.sha }}"

          # Handle initial commit or force push
          if [ "$BASE_SHA" = "0000000000000000000000000000000000000000" ]; then
            echo "Initial commit or force push - building all services"
            BASE_SHA=$(git rev-parse HEAD~1 2>/dev/null || echo "")
          fi

          if [ -z "$BASE_SHA" ]; then
            # Fallback: find all services
            SERVICES='[]'
            for dir in services core plugins; do
              if [ -d "$dir" ]; then
                while IFS= read -r -d '' dockerfile; do
                  service_path=$(dirname "$dockerfile")
                  service_name=$(basename "$service_path")
                  SERVICES=$(echo "$SERVICES" | jq --arg name "$service_name" --arg path "$service_path" '. + [{"name": $name, "path": $path, "type": "service"}]')
                done < <(find "$dir" -name "Dockerfile" -print0 2>/dev/null)
              fi
            done
            COUNT=$(echo "$SERVICES" | jq 'length')
          else
            # Run detection script
            RESULT=$(.github/scripts/ci/detect-changed-services.sh "$BASE_SHA" "$HEAD_SHA")
            SERVICES=$(echo "$RESULT" | jq -c '.services')
            COUNT=$(echo "$RESULT" | jq -r '.count')
          fi

          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          echo "count=$COUNT" >> $GITHUB_OUTPUT

          if [ "$COUNT" -gt 0 ]; then
            echo "has-changes=true" >> $GITHUB_OUTPUT
          else
            echo "has-changes=false" >> $GITHUB_OUTPUT
          fi

          echo "Found $COUNT service(s) to deploy"
          echo "$SERVICES" | jq '.'

  # ============================================
  # Job 2: Build and Push Images
  # ============================================
  build-and-push:
    name: Build & Push
    needs: [detect-changes]
    if: ${{ needs.detect-changes.outputs.has-changes == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJSON(needs.detect-changes.outputs.services) }}
    outputs:
      # Note: Matrix jobs can't easily aggregate outputs
      # We'll handle this in the summary job
      image-${{ matrix.service.name }}: ${{ steps.meta.outputs.image-ref }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Docker
        uses: ./.github/actions/setup-arc-docker
        with:
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate image metadata
        id: meta
        run: |
          SERVICE="${{ matrix.service.name }}"
          SHA="${{ github.sha }}"
          SHORT_SHA="${SHA:0:7}"

          # Image reference
          IMAGE_REF="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${SERVICE}"

          # Tags: dev-<sha>, dev-latest
          TAGS="${IMAGE_REF}:dev-${SHORT_SHA},${IMAGE_REF}:dev-latest"

          echo "image-ref=${IMAGE_REF}:dev-${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "tags=$TAGS" >> $GITHUB_OUTPUT

          echo "Building: $SERVICE"
          echo "Tags: $TAGS"

      - name: Build and push image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.path }}
          file: ${{ matrix.service.path }}/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha,scope=${{ matrix.service.name }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service.name }}
          sbom: true
          provenance: true
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.title=${{ matrix.service.name }}
            org.opencontainers.image.description=A.R.C. Platform Service
            arc.service.name=${{ matrix.service.name }}
            arc.build.branch=main
            arc.build.workflow-run-id=${{ github.run_id }}

      - name: Generate build summary
        run: |
          echo "## Build: ${{ matrix.service.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Image** | \`${{ steps.meta.outputs.image-ref }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Digest** | \`${{ steps.build.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **SBOM** | âœ… Generated |" >> $GITHUB_STEP_SUMMARY
          echo "| **Provenance** | âœ… Attached |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Image pushed to GHCR" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Job 3: Security Scan Published Images
  # ============================================
  security-scan:
    name: Security Scan
    needs: [detect-changes, build-and-push]
    if: ${{ needs.detect-changes.outputs.has-changes == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      issues: write
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJSON(needs.detect-changes.outputs.services) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup validation tools
        uses: ./.github/actions/setup-arc-validation

      - name: Generate image reference
        id: image
        run: |
          SERVICE="${{ matrix.service.name }}"
          SHA="${{ github.sha }}"
          SHORT_SHA="${SHA:0:7}"
          IMAGE_REF="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${SERVICE}:dev-${SHORT_SHA}"
          echo "ref=$IMAGE_REF" >> $GITHUB_OUTPUT

      - name: Scan image with Trivy
        id: scan
        run: |
          IMAGE="${{ steps.image.outputs.ref }}"

          echo "Scanning image: $IMAGE"

          # Run Trivy scan
          trivy image \
            --severity CRITICAL,HIGH \
            --ignore-unfixed \
            --format json \
            --output trivy-results.json \
            "$IMAGE" || true

          # Generate SARIF for GitHub Security
          trivy image \
            --severity CRITICAL,HIGH \
            --ignore-unfixed \
            --format sarif \
            --output trivy-results.sarif \
            "$IMAGE" || true

          # Count vulnerabilities
          CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' trivy-results.json 2>/dev/null || echo "0")
          HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' trivy-results.json 2>/dev/null || echo "0")

          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT

          echo "Found: $CRITICAL CRITICAL, $HIGH HIGH vulnerabilities"

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif
          category: trivy-${{ matrix.service.name }}
        continue-on-error: true

      - name: Create issue for critical CVEs
        if: ${{ steps.scan.outputs.critical > 0 }}
        uses: ./.github/actions/arc-notify
        with:
          notification-type: github-issue
          title: "CRITICAL CVE in ${{ matrix.service.name }} (main branch)"
          body: |
            ## Security Alert

            **${{ steps.scan.outputs.critical }}** CRITICAL vulnerability(ies) detected in `${{ matrix.service.name }}` on main branch.

            ### Details
            - **Image:** `${{ steps.image.outputs.ref }}`
            - **CRITICAL:** ${{ steps.scan.outputs.critical }}
            - **HIGH:** ${{ steps.scan.outputs.high }}
            - **Commit:** ${{ github.sha }}

            ### Action Required
            1. Review the [Security tab](${{ github.server_url }}/${{ github.repository }}/security) for CVE details
            2. Update affected dependencies
            3. Create a new PR with the fix

            ### Workflow Run
            [View details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          labels: 'security,cve,critical,main-branch'
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate scan summary
        run: |
          echo "## Security Scan: ${{ matrix.service.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| CRITICAL | ${{ steps.scan.outputs.critical }} |" >> $GITHUB_STEP_SUMMARY
          echo "| HIGH | ${{ steps.scan.outputs.high }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.scan.outputs.critical }}" -gt 0 ]; then
            echo "âš ï¸ **Warning:** CRITICAL vulnerabilities detected. Issue created." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No CRITICAL vulnerabilities" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail on critical CVEs (optional - currently warning only)
        if: ${{ steps.scan.outputs.critical > 0 }}
        run: |
          echo "::warning::CRITICAL CVEs found in ${{ matrix.service.name }} - issue created"
          # Uncomment to block deployment on CRITICAL CVEs:
          # exit 1

  # ============================================
  # Job 4: Deployment Summary
  # ============================================
  summary:
    name: Deployment Summary
    needs: [detect-changes, build-and-push, security-scan]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate deployment summary
        env:
          COMMIT_AUTHOR: ${{ github.event.head_commit.author.name }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
        run: |
          echo "## ðŸš€ Main Branch Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** [\`${GITHUB_SHA:0:7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** $COMMIT_AUTHOR" >> $GITHUB_STEP_SUMMARY
          echo "**Message:** $COMMIT_MESSAGE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          SERVICE_COUNT="${{ needs.detect-changes.outputs.service-count }}"

          if [ "$SERVICE_COUNT" = "0" ]; then
            echo "### No Services Deployed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No services with Dockerfiles were modified in this commit." >> $GITHUB_STEP_SUMMARY
          else
            echo "### Deployed Services ($SERVICE_COUNT)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Service | Image Tag | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|-----------|--------|" >> $GITHUB_STEP_SUMMARY

            # Parse services and show status
            SERVICES='${{ needs.detect-changes.outputs.services }}'
            echo "$SERVICES" | jq -r '.[] | "| \(.name) | `dev-${GITHUB_SHA:0:7}` | âœ… Published |"' | \
              sed "s/\${GITHUB_SHA:0:7}/${GITHUB_SHA:0:7}/g" >> $GITHUB_STEP_SUMMARY

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Registry" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Images available at: \`${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/\`" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY

          # Overall status
          BUILD_STATUS="${{ needs.build-and-push.result }}"
          SCAN_STATUS="${{ needs.security-scan.result }}"

          echo "### Job Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY

          case "$BUILD_STATUS" in
            success) echo "| Build & Push | âœ… Success |" >> $GITHUB_STEP_SUMMARY ;;
            failure) echo "| Build & Push | âŒ Failed |" >> $GITHUB_STEP_SUMMARY ;;
            skipped) echo "| Build & Push | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY ;;
            *) echo "| Build & Push | âš ï¸ $BUILD_STATUS |" >> $GITHUB_STEP_SUMMARY ;;
          esac

          case "$SCAN_STATUS" in
            success) echo "| Security Scan | âœ… Success |" >> $GITHUB_STEP_SUMMARY ;;
            failure) echo "| Security Scan | âš ï¸ Issues Found |" >> $GITHUB_STEP_SUMMARY ;;
            skipped) echo "| Security Scan | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY ;;
            *) echo "| Security Scan | âš ï¸ $SCAN_STATUS |" >> $GITHUB_STEP_SUMMARY ;;
          esac

      - name: Set final status
        run: |
          BUILD_STATUS="${{ needs.build-and-push.result }}"

          if [ "$BUILD_STATUS" = "failure" ]; then
            echo "::error::Deployment failed - build step failed"
            exit 1
          fi

          echo "Deployment completed successfully!"
