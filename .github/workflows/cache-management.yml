# Cache Management Workflow
# Monitors and cleans up GitHub Actions caches
#
# Features:
# - Lists all caches with usage stats
# - Cleans up stale branch caches
# - Reports cache hit rates
#
# Part of A.R.C. CI/CD Optimization - Phase 8: Cost Controller

name: Cache Management

on:
  schedule:
    # Run weekly on Sunday at 6 AM UTC
    - cron: '0 6 * * 0'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'report'
        type: choice
        options:
          - report
          - cleanup-stale
          - cleanup-branch
      branch:
        description: 'Branch name (for cleanup-branch action)'
        required: false
        type: string
      dry_run:
        description: 'Dry run (show what would be deleted)'
        required: false
        default: true
        type: boolean

permissions:
  contents: read
  actions: write

env:
  # Caches older than this are considered stale
  STALE_DAYS: 14

jobs:
  list-caches:
    name: List Caches
    runs-on: ubuntu-latest
    outputs:
      total_count: ${{ steps.list.outputs.total_count }}
      total_size_mb: ${{ steps.list.outputs.total_size_mb }}
    steps:
      - name: List all caches
        id: list
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "## ðŸ“¦ Cache Inventory" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Get cache list
          CACHES=$(gh api \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/actions/caches \
            --paginate)

          TOTAL_COUNT=$(echo "$CACHES" | jq -s '[.[].actions_caches | length] | add')
          TOTAL_SIZE=$(echo "$CACHES" | jq -s '[.[].actions_caches[].size_in_bytes] | add // 0')
          TOTAL_SIZE_MB=$(echo "scale=2; $TOTAL_SIZE / 1048576" | bc)

          echo "total_count=$TOTAL_COUNT" >> "$GITHUB_OUTPUT"
          echo "total_size_mb=$TOTAL_SIZE_MB" >> "$GITHUB_OUTPUT"

          echo "### Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Metric | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Total Caches | $TOTAL_COUNT |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Total Size | ${TOTAL_SIZE_MB} MB |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Group by cache key prefix
          echo "### By Cache Type" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Type | Count | Size (MB) |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|-------|-----------|" >> "$GITHUB_STEP_SUMMARY"

          echo "$CACHES" | jq -rs '
            [.[].actions_caches[]] |
            group_by(.key | split("-")[0:2] | join("-")) |
            map({
              type: .[0].key | split("-")[0:2] | join("-"),
              count: length,
              size: ([.[].size_in_bytes] | add // 0)
            }) |
            sort_by(-.size) |
            .[] |
            "| \(.type) | \(.count) | \(.size / 1048576 | . * 100 | floor / 100) |"
          ' >> "$GITHUB_STEP_SUMMARY" || echo "| (no caches) | 0 | 0 |" >> "$GITHUB_STEP_SUMMARY"

          echo "" >> "$GITHUB_STEP_SUMMARY"

          # List by branch
          echo "### By Branch" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Branch | Count | Size (MB) |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|-------|-----------|" >> "$GITHUB_STEP_SUMMARY"

          echo "$CACHES" | jq -rs '
            [.[].actions_caches[]] |
            group_by(.ref) |
            map({
              branch: .[0].ref,
              count: length,
              size: ([.[].size_in_bytes] | add // 0)
            }) |
            sort_by(-.size) |
            .[:10] |
            .[] |
            "| \(.branch) | \(.count) | \(.size / 1048576 | . * 100 | floor / 100) |"
          ' >> "$GITHUB_STEP_SUMMARY" || echo "| (no caches) | 0 | 0 |" >> "$GITHUB_STEP_SUMMARY"

  cleanup-stale:
    name: Cleanup Stale Caches
    runs-on: ubuntu-latest
    needs: list-caches
    if: github.event.inputs.action == 'cleanup-stale' || github.event_name == 'schedule'
    steps:
      - name: Find and delete stale caches
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'true' }}
        run: |
          echo "## ðŸ§¹ Stale Cache Cleanup" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Calculate cutoff date
          CUTOFF=$(date -d "${{ env.STALE_DAYS }} days ago" +%Y-%m-%dT%H:%M:%SZ)
          echo "Cutoff date: $CUTOFF" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Get stale caches
          CACHES=$(gh api \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/actions/caches \
            --paginate)

          STALE_CACHES=$(echo "$CACHES" | jq -rs --arg cutoff "$CUTOFF" '
            [.[].actions_caches[] | select(.last_accessed_at < $cutoff)]
          ')

          STALE_COUNT=$(echo "$STALE_CACHES" | jq 'length')
          STALE_SIZE=$(echo "$STALE_CACHES" | jq '[.[].size_in_bytes] | add // 0')
          STALE_SIZE_MB=$(echo "scale=2; $STALE_SIZE / 1048576" | bc)

          echo "Found $STALE_COUNT stale caches (${STALE_SIZE_MB} MB)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ "$STALE_COUNT" -eq 0 ]; then
            echo "No stale caches to clean up." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          DELETED=0
          FAILED=0

          echo "| Cache Key | Last Accessed | Size (MB) | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-----------|---------------|-----------|--------|" >> "$GITHUB_STEP_SUMMARY"

          echo "$STALE_CACHES" | jq -r '.[] | "\(.id)|\(.key)|\(.last_accessed_at)|\(.size_in_bytes)"' | while IFS='|' read -r id key last_accessed size; do
            SIZE_MB=$(echo "scale=2; $size / 1048576" | bc)

            if [ "$DRY_RUN" = "true" ]; then
              echo "| ${key:0:50}... | $last_accessed | $SIZE_MB | Would delete |" >> "$GITHUB_STEP_SUMMARY"
            else
              if gh api \
                --method DELETE \
                -H "Accept: application/vnd.github+json" \
                /repos/${{ github.repository }}/actions/caches/$id 2>/dev/null; then
                echo "| ${key:0:50}... | $last_accessed | $SIZE_MB | âœ… Deleted |" >> "$GITHUB_STEP_SUMMARY"
                DELETED=$((DELETED + 1))
              else
                echo "| ${key:0:50}... | $last_accessed | $SIZE_MB | âŒ Failed |" >> "$GITHUB_STEP_SUMMARY"
                FAILED=$((FAILED + 1))
              fi
            fi
          done

          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ "$DRY_RUN" = "true" ]; then
            echo "**Dry run mode** - no caches were deleted." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Deleted: $DELETED caches, Failed: $FAILED" >> "$GITHUB_STEP_SUMMARY"
          fi

  cleanup-branch:
    name: Cleanup Branch Caches
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'cleanup-branch' && github.event.inputs.branch != ''
    steps:
      - name: Delete caches for branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: ${{ github.event.inputs.branch }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'true' }}
        run: |
          echo "## ðŸ—‘ï¸ Branch Cache Cleanup" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Target branch: \`$BRANCH\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Get caches for this branch
          CACHES=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/actions/caches?ref=refs/heads/$BRANCH" \
            --paginate 2>/dev/null || echo '{"actions_caches":[]}')

          CACHE_COUNT=$(echo "$CACHES" | jq -s '[.[].actions_caches | length] | add // 0')

          if [ "$CACHE_COUNT" -eq 0 ]; then
            echo "No caches found for branch \`$BRANCH\`" >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          echo "Found $CACHE_COUNT caches for branch" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "| Cache Key | Size (MB) | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-----------|-----------|--------|" >> "$GITHUB_STEP_SUMMARY"

          echo "$CACHES" | jq -rs '[.[].actions_caches[]] | .[] | "\(.id)|\(.key)|\(.size_in_bytes)"' | while IFS='|' read -r id key size; do
            [ -z "$id" ] && continue

            SIZE_MB=$(echo "scale=2; $size / 1048576" | bc)

            if [ "$DRY_RUN" = "true" ]; then
              echo "| ${key:0:60}... | $SIZE_MB | Would delete |" >> "$GITHUB_STEP_SUMMARY"
            else
              if gh api \
                --method DELETE \
                -H "Accept: application/vnd.github+json" \
                /repos/${{ github.repository }}/actions/caches/$id 2>/dev/null; then
                echo "| ${key:0:60}... | $SIZE_MB | âœ… Deleted |" >> "$GITHUB_STEP_SUMMARY"
              else
                echo "| ${key:0:60}... | $SIZE_MB | âŒ Failed |" >> "$GITHUB_STEP_SUMMARY"
              fi
            fi
          done

          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ "$DRY_RUN" = "true" ]; then
            echo "**Dry run mode** - no caches were deleted." >> "$GITHUB_STEP_SUMMARY"
          fi

  # Auto-cleanup merged branch caches
  cleanup-merged-branches:
    name: Cleanup Merged Branch Caches
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Find merged branches with caches
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "## ðŸ”€ Merged Branch Cache Cleanup" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Get all branches with caches
          CACHES=$(gh api \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/actions/caches \
            --paginate)

          # Get unique branch refs from caches
          CACHE_BRANCHES=$(echo "$CACHES" | jq -rs '[.[].actions_caches[].ref] | unique | .[]' | grep "refs/heads/" | sed 's|refs/heads/||')

          # Get current branches
          CURRENT_BRANCHES=$(gh api \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/branches \
            --paginate | jq -rs '[.[].name] | unique | .[]')

          echo "| Branch | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|--------|" >> "$GITHUB_STEP_SUMMARY"

          ORPHANED=0
          for branch in $CACHE_BRANCHES; do
            if ! echo "$CURRENT_BRANCHES" | grep -q "^${branch}$"; then
              echo "| \`$branch\` | ðŸ—‘ï¸ Branch deleted/merged |" >> "$GITHUB_STEP_SUMMARY"
              ORPHANED=$((ORPHANED + 1))

              # Delete caches for this branch (dry run in scheduled mode)
              # In production, remove the echo to actually delete
              echo "Would delete caches for orphaned branch: $branch"
            fi
          done

          if [ "$ORPHANED" -eq 0 ]; then
            echo "| (none) | All branches current |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Found $ORPHANED orphaned branch caches. Run with \`cleanup-branch\` action to delete." >> "$GITHUB_STEP_SUMMARY"
          fi
