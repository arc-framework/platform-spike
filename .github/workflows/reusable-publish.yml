name: ‚ôªÔ∏è Reusable Package Publish

on:
  workflow_call:
    inputs:
      group_name:
        required: true
        type: string
      image_list:
        required: true
        type: string # We will pass the list as a multiline string
    secrets:
      gh_token:
        required: true

env:
  REGISTRY: ghcr.io
  NAMESPACE: arc-framework
  VERSION: v1.0.0
  SOURCE_URL: "https://github.com/arc-framework/arc-platform"
  LICENSE: "Apache-2.0"

jobs:
  mirror-images:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Log in to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.gh_token }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Process Images
        shell: bash
        run: |
          echo "üì¶ Processing Group: ${{ inputs.group_name }}"
          
          # Read the multiline input string line by line
          while IFS= read -r line; do
            # Skip empty lines or comments
            if [[ -z "$line" || "$line" == \#* ]]; then continue; fi
            
            # Split line by "="
            IFS='=' read -r source target <<< "$line"
            
            # Trim whitespace
            source=$(echo "$source" | xargs)
            target=$(echo "$target" | xargs)
            
            full_target="${{ env.REGISTRY }}/${{ env.NAMESPACE }}/$target"

            echo "   üöÄ Mirroring: $source -> $target"

            docker buildx build \
                --platform linux/amd64,linux/arm64 \
                --tag "$full_target:${{ env.VERSION }}" \
                --tag "$full_target:latest" \
                --label "org.opencontainers.image.source=${{ env.SOURCE_URL }}" \
                --label "org.opencontainers.image.description=A.R.C. Mirror: ${{ inputs.group_name }}" \
                --label "org.opencontainers.image.licenses=${{ env.LICENSE }}" \
                --output type=image,push=true \
                - <<EOF
          FROM $source
          EOF
          
          done <<< "${{ inputs.image_list }}"
