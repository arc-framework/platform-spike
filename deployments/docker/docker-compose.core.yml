# A.R.C. Framework - Core Services
# ==============================================================================
# Required infrastructure components that the framework depends on
# These services are MANDATORY and cannot be removed
# ==============================================================================

# Shared logging configuration
x-logging: &default-logging
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"
      labels: "arc.service"

# Shared resource limits for lightweight services
x-resources-small: &resources-small
  deploy:
    resources:
      limits:
        cpus: '0.5'
        memory: 512M
      reservations:
        cpus: '0.1'
        memory: 128M

# Shared resource limits for medium services
x-resources-medium: &resources-medium
  deploy:
    resources:
      limits:
        cpus: '1.0'
        memory: 1G
      reservations:
        cpus: '0.25'
        memory: 256M

# Shared resource limits for large services (databases, message queues)
x-resources-large: &resources-large
  deploy:
    resources:
      limits:
        cpus: '2.0'
        memory: 2G
      reservations:
        cpus: '0.5'
        memory: 512M

# Combined templates (logging + resources)
x-small-service: &small-service
  <<: *default-logging
  deploy:
    resources:
      limits:
        cpus: '0.5'
        memory: 512M
      reservations:
        cpus: '0.1'
        memory: 128M

x-medium-service: &medium-service
  <<: *default-logging
  deploy:
    resources:
      limits:
        cpus: '1.0'
        memory: 1G
      reservations:
        cpus: '0.25'
        memory: 256M

x-large-service: &large-service
  <<: *default-logging
  deploy:
    resources:
      limits:
        cpus: '2.0'
        memory: 2G
      reservations:
        cpus: '0.5'
        memory: 512M

services:
  # ===========================================================================
  # GATEWAY - API Gateway & Reverse Proxy
  # ===========================================================================
  arc-heimdall-gateway:
    <<: *small-service
    image: ghcr.io/arc-framework/arc-heimdall-gateway:latest
    container_name: arc-heimdall-gateway
    hostname: arc-heimdall-gateway
    restart: unless-stopped
    command:
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--log.level=INFO"
      - "--ping=true"
    ports:
      - "80:80"      # HTTP
      - "443:443"    # HTTPS
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ../../core/gateway/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
    networks:
      arc_net:
        aliases:
          - traefik
          - arc-traefik
          - arc_traefik
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:80/ping || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    labels:
      - "arc.service.layer=core"
      - "arc.service.category=gateway"
      - "arc.service.codename=heimdall"
      - "arc.service.role=The Gatekeeper"
      - "arc.service.tech=traefik"
      - "arc.service.swappable=false"

  # ===========================================================================
  # TELEMETRY - OpenTelemetry Collector
  # ===========================================================================
  arc-widow-otel:
    <<: *medium-service
    build:
      context: ../../core/telemetry/otel-collector
      dockerfile: Dockerfile
    image: arc/otel-collector:latest
    container_name: arc-widow-otel
    hostname: arc-widow-otel
    restart: unless-stopped
    command: ["--config=/etc/otel-collector-config.yml"]
    volumes:
      - ../../core/telemetry/otel-collector-config.yml:/etc/otel-collector-config.yml:ro
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
      - "13133:13133" # Health Check
      - "8888:8888"   # Prometheus metrics
    networks:
      arc_net:
        aliases:
          - otel-collector
          - arc-otel
          - arc_otel_collector
    depends_on:
      arc-heimdall-gateway:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "/health_check", "http://localhost:13133"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s
    environment:
      - OTEL_LOG_LEVEL=info
    labels:
      - "arc.service.layer=core"
      - "arc.service.category=telemetry"
      - "arc.service.codename=widow"
      - "arc.service.role=The All-Seeing"
      - "arc.service.tech=opentelemetry"
      - "arc.service.swappable=false"

  # ===========================================================================
  # PERSISTENCE - PostgreSQL with pgvector
  # ===========================================================================
  arc-oracle-sql:
    <<: *large-service
    image: ghcr.io/arc-framework/arc-oracle-sql:latest
    container_name: arc-oracle-sql
    hostname: arc-oracle-sql
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-arc}
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:?Error: POSTGRES_PASSWORD must be set in .env file}"
      POSTGRES_DB: ${POSTGRES_DB:-arc_db}
      POSTGRES_INITDB_ARGS: "-E UTF8"
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - arc_postgres_data:/var/lib/postgresql/data
      - ../../core/persistence/postgres/init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    ports:
      - "5432:5432"
    networks:
      arc_net:
        aliases:
          - postgres
          - arc-postgres
          - arc_postgres
          - arc-oracle
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U arc -d arc_db"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    labels:
      - "arc.service.layer=core"
      - "arc.service.category=persistence"
      - "arc.service.codename=oracle"
      - "arc.service.role=The Knowledge Keeper"
      - "arc.service.tech=postgresql"
      - "arc.service.swappable=false"
    shm_size: 256mb

  # ===========================================================================
  # CACHING - Redis
  # ===========================================================================
  arc-sonic-cache:
    <<: *medium-service
    image: ghcr.io/arc-framework/arc-sonic-cache:latest
    container_name: arc-sonic-cache
    hostname: arc-sonic-cache
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 512mb
      --maxmemory-policy noeviction
    volumes:
      - arc_redis_data:/data
    ports:
      - "6379:6379"
    networks:
      arc_net:
        aliases:
          - redis
          - arc-redis
          - arc_redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 3s
    labels:
      - "arc.service.layer=core"
      - "arc.service.category=caching"
      - "arc.service.codename=sonic"
      - "arc.service.role=The Speedster"
      - "arc.service.tech=redis"
      - "arc.service.swappable=false"

  # ===========================================================================
  # MESSAGING (EPHEMERAL) - NATS
  # ===========================================================================
  arc-flash-pulse:
    <<: *small-service
    image: ghcr.io/arc-framework/arc-flash-pulse:latest
    container_name: arc-flash-pulse
    hostname: arc-flash-pulse
    restart: unless-stopped
    command: >
      --jetstream
      --store_dir /data
      --http_port 8222
    volumes:
      - ../../core/messaging/ephemeral/nats/data:/data
    ports:
      - "4222:4222"  # Client connections
      - "8222:8222"  # Monitoring
      - "6222:6222"  # Cluster routes
    networks:
      arc_net:
        aliases:
          - nats
          - arc-nats
          - arc_nats
    depends_on:
      arc-widow-otel:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8222/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    labels:
      - "arc.service.layer=core"
      - "arc.service.category=messaging"
      - "arc.service.subcategory=ephemeral"
      - "arc.service.codename=flash"
      - "arc.service.role=The Messenger"
      - "arc.service.tech=nats"
      - "arc.service.swappable=false"

  # ===========================================================================
  # MESSAGING (DURABLE) - Apache Pulsar
  # ===========================================================================
  arc-strange-stream:
    <<: *large-service
    image: ghcr.io/arc-framework/arc-strange-stream:latest
    container_name: arc-strange-stream
    hostname: arc-strange-stream
    restart: unless-stopped
    command: >
      bin/pulsar standalone
      --no-functions-worker
    environment:
      PULSAR_MEM: "-Xms512m -Xmx1024m -XX:MaxDirectMemorySize=512m"
      PULSAR_GC: "-XX:+UseG1GC"
    volumes:
      - arc_pulsar_data:/pulsar/data
    ports:
      - "6650:6650"  # Broker
      - "8082:8080"  # HTTP Admin (mapped to 8082 to avoid conflict with Traefik)
    networks:
      arc_net:
        aliases:
          - pulsar
          - arc-pulsar
          - arc_pulsar
    depends_on:
      arc-oracle-sql:
        condition: service_healthy
      arc-widow-otel:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/admin/v2/brokers/health || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 15
      start_period: 60s
    labels:
      - "arc.service.layer=core"
      - "arc.service.category=messaging"
      - "arc.service.subcategory=durable"
      - "arc.service.codename=strange"
      - "arc.service.role=The Time Keeper"
      - "arc.service.tech=pulsar"
      - "arc.service.swappable=false"

  # ===========================================================================
  # SECRETS - Infisical
  # ===========================================================================
  arc-fury-vault:
    <<: *medium-service
    image: ghcr.io/arc-framework/arc-fury-vault:latest
    container_name: arc-fury-vault
    hostname: arc-fury-vault
    restart: unless-stopped
    environment:
      DB_CONNECTION_URI: "postgres://${POSTGRES_USER:-arc}:${POSTGRES_PASSWORD:?Error: POSTGRES_PASSWORD must be set}@arc-oracle-sql:5432/infisical_db?sslmode=disable"
      REDIS_URL: "redis://arc-sonic-cache:6379"
      ENCRYPTION_KEY: "${INFISICAL_ENCRYPTION_KEY:?Error: INFISICAL_ENCRYPTION_KEY must be set}"
      AUTH_SECRET: "${INFISICAL_AUTH_SECRET:?Error: INFISICAL_AUTH_SECRET must be set}"
      SITE_URL: ${INFISICAL_SITE_URL:-http://localhost:3001}
      TELEMETRY_ENABLED: "false"
    depends_on:
      arc-oracle-sql:
        condition: service_healthy
      arc-sonic-cache:
        condition: service_healthy
    ports:
      - "3001:8080"
    networks:
      arc_net:
        aliases:
          - infisical
          - arc-infisical
          - arc_infisical
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/status"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 120s
    labels:
      - "arc.service.layer=core"
      - "arc.service.category=secrets"
      - "arc.service.codename=fury"
      - "arc.service.role=The Spymaster"
      - "arc.service.tech=infisical"
      - "arc.service.swappable=false"

  # ===========================================================================
  # FEATURE MANAGEMENT - Unleash
  # ===========================================================================
  arc-mystique-flags:
    <<: *medium-service
    image: ghcr.io/arc-framework/arc-mystique-flags:latest
    container_name: arc-mystique-flags
    hostname: arc-mystique-flags
    restart: unless-stopped
    environment:
      DATABASE_URL: "postgres://${POSTGRES_USER:-arc}:${POSTGRES_PASSWORD:?Error: POSTGRES_PASSWORD must be set}@arc-oracle-sql:5432/unleash_db?sslmode=disable"
      DATABASE_SSL: "false"
      LOG_LEVEL: info
    depends_on:
      arc-oracle-sql:
        condition: service_healthy
    ports:
      - "4242:4242"
    networks:
      arc_net:
        aliases:
          - unleash
          - arc-unleash
          - arc_unleash
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4242/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    labels:
      - "arc.service.layer=core"
      - "arc.service.category=feature-management"
      - "arc.service.codename=mystique"
      - "arc.service.role=The Shapeshifter"
      - "arc.service.tech=unleash"
      - "arc.service.swappable=false"

  # ===========================================================================
  # MEDIA - LiveKit (WebRTC SFU)
  # ===========================================================================
  arc-daredevil-voice:
    <<: *medium-service
    image: ghcr.io/arc-framework/arc-daredevil-voice:latest
    container_name: arc-daredevil-voice
    hostname: arc-daredevil-voice
    restart: unless-stopped
    command:
      - "--config"
      - "/etc/livekit.yaml"
      - "--node-ip"
      - "${LIVEKIT_NODE_IP:-127.0.0.1}"
    environment:
      LIVEKIT_KEYS: "devkey: secret"  # Format MUST be "key: secret" with space
      REDIS_PASSWORD: ""
    volumes:
      - ../../core/media/livekit/livekit.yaml:/etc/livekit.yaml:ro
    ports:
      - "7880:7880"        # HTTP API & WebSocket signaling
      - "7881:7881/tcp"    # TCP fallback
      - "50000-50100:50000-50100/udp"  # WebRTC media (100 ports for dev)
    networks:
      arc_net:
        aliases:
          - livekit
          - arc-livekit
          - arc_livekit
    depends_on:
      arc-sonic-cache:
        condition: service_healthy
      arc-widow-otel:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7880/metrics || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    labels:
      - "arc.service.layer=core"
      - "arc.service.category=media"
      - "arc.service.codename=daredevil"
      - "arc.service.role=The Listener"
      - "arc.service.tech=livekit"
      - "arc.service.swappable=false"
      - "traefik.enable=true"
      - "traefik.http.routers.livekit.rule=Host(`livekit.arc.local`)"
      - "traefik.http.routers.livekit.entrypoints=web"
      - "traefik.http.routers.livekit.service=livekit"
      - "traefik.http.services.livekit.loadbalancer.server.port=7880"
