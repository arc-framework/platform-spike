# A.R.C. Framework - Core Services
# ==============================================================================
# Required infrastructure components that the framework depends on
# These services are MANDATORY and cannot be removed
# ==============================================================================

# Shared logging configuration
x-logging: &default-logging
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"
      labels: "arc.service"

# Shared resource limits for lightweight services
x-resources-small: &resources-small
  deploy:
    resources:
      limits:
        cpus: '0.5'
        memory: 512M
      reservations:
        cpus: '0.1'
        memory: 128M

# Shared resource limits for medium services
x-resources-medium: &resources-medium
  deploy:
    resources:
      limits:
        cpus: '1.0'
        memory: 1G
      reservations:
        cpus: '0.25'
        memory: 256M

# Shared resource limits for large services (databases, message queues)
x-resources-large: &resources-large
  deploy:
    resources:
      limits:
        cpus: '2.0'
        memory: 2G
      reservations:
        cpus: '0.5'
        memory: 512M

# Combined templates (logging + resources)
x-small-service: &small-service
  <<: *default-logging
  deploy:
    resources:
      limits:
        cpus: '0.5'
        memory: 512M
      reservations:
        cpus: '0.1'
        memory: 128M

x-medium-service: &medium-service
  <<: *default-logging
  deploy:
    resources:
      limits:
        cpus: '1.0'
        memory: 1G
      reservations:
        cpus: '0.25'
        memory: 256M

x-large-service: &large-service
  <<: *default-logging
  deploy:
    resources:
      limits:
        cpus: '2.0'
        memory: 2G
      reservations:
        cpus: '0.5'
        memory: 512M

services:
  # ===========================================================================
  # GATEWAY - API Gateway & Reverse Proxy
  # ===========================================================================
  arc_traefik:
    <<: *small-service
    image: traefik:latest
    container_name: arc_traefik
    restart: unless-stopped
    command:
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--log.level=INFO"
      - "--ping=true"
    ports:
      - "80:80"      # HTTP
      - "443:443"    # HTTPS
      - "8080:8080"  # Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ../../core/gateway/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
    networks:
      - arc_net
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    labels:
      - "arc.service.layer=core"
      - "arc.service.category=gateway"

  # ===========================================================================
  # TELEMETRY - OpenTelemetry Collector
  # ===========================================================================
  arc_otel_collector:
    <<: *medium-service
    build:
      context: ../../core/telemetry/otel-collector
      dockerfile: Dockerfile
    image: arc/otel-collector:latest
    container_name: arc_otel_collector
    restart: unless-stopped
    command: ["--config=/etc/otel-collector-config.yml"]
    volumes:
      - ../../core/telemetry/otel-collector-config.yml:/etc/otel-collector-config.yml:ro
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
      - "13133:13133" # Health Check
      - "8888:8888"   # Prometheus metrics
    networks:
      - arc_net
    healthcheck:
      test: ["CMD", "/health_check", "http://localhost:13133"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s
    environment:
      - OTEL_LOG_LEVEL=info
    labels:
      - "arc.service.layer=core"
      - "arc.service.category=telemetry"

  # ===========================================================================
  # PERSISTENCE - PostgreSQL with pgvector
  # ===========================================================================
  arc_postgres:
    <<: *large-service
    image: pgvector/pgvector:pg17
    container_name: arc_postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-arc}
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:?Error: POSTGRES_PASSWORD must be set in .env file}"
      POSTGRES_DB: ${POSTGRES_DB:-arc_db}
      POSTGRES_INITDB_ARGS: "-E UTF8"
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - arc_postgres_data:/var/lib/postgresql/data
      - ../../core/persistence/postgres/init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    ports:
      - "5432:5432"
    networks:
      - arc_net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-arc} -d ${POSTGRES_DB:-arc_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    labels:
      - "arc.service.layer=core"
      - "arc.service.category=persistence"
    shm_size: 256mb

  # ===========================================================================
  # CACHING - Redis
  # ===========================================================================
  arc_redis:
    <<: *medium-service
    image: redis:7-alpine
    container_name: arc_redis
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 512mb
      --maxmemory-policy noeviction
    volumes:
      - arc_redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - arc_net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    labels:
      - "arc.service.layer=core"
      - "arc.service.category=caching"

  # ===========================================================================
  # MESSAGING (EPHEMERAL) - NATS
  # ===========================================================================
  arc_nats:
    <<: *small-service
    image: nats:2.12.1
    container_name: arc_nats
    restart: unless-stopped
    command: >
      --jetstream
      --store_dir /data
      --http_port 8222
    volumes:
      - ../../core/messaging/ephemeral/nats/data:/data
    ports:
      - "4222:4222"  # Client connections
      - "8222:8222"  # Monitoring
      - "6222:6222"  # Cluster routes
    networks:
      - arc_net
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8222/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    labels:
      - "arc.service.layer=core"
      - "arc.service.category=messaging"
      - "arc.service.subcategory=ephemeral"

  # ===========================================================================
  # MESSAGING (DURABLE) - Apache Pulsar
  # ===========================================================================
  arc_pulsar:
    <<: *large-service
    image: apachepulsar/pulsar:latest
    container_name: arc_pulsar
    restart: unless-stopped
    command: >
      bin/pulsar standalone
      --no-functions-worker
      --wipe-data
    environment:
      PULSAR_MEM: "-Xms512m -Xmx1024m -XX:MaxDirectMemorySize=512m"
      PULSAR_GC: "-XX:+UseG1GC"
    volumes:
      - arc_pulsar_data:/pulsar/data
    ports:
      - "6650:6650"  # Broker
      - "8082:8080"  # HTTP Admin (mapped to 8082 to avoid conflict with Traefik)
    networks:
      - arc_net
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/admin/v2/brokers/health || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 30s
    labels:
      - "arc.service.layer=core"
      - "arc.service.category=messaging"
      - "arc.service.subcategory=durable"

  # ===========================================================================
  # SECRETS - Infisical
  # ===========================================================================
  arc_infisical:
    <<: *medium-service
    image: infisical/infisical:latest-postgres
    container_name: arc_infisical
    restart: unless-stopped
    environment:
      DB_CONNECTION_URI: "postgres://${POSTGRES_USER:-arc}:${POSTGRES_PASSWORD:?Error: POSTGRES_PASSWORD must be set}@arc_postgres:5432/infisical_db?sslmode=disable"
      REDIS_URL: "redis://arc_redis:6379"
      ENCRYPTION_KEY: "${INFISICAL_ENCRYPTION_KEY:?Error: INFISICAL_ENCRYPTION_KEY must be set}"
      AUTH_SECRET: "${INFISICAL_AUTH_SECRET:?Error: INFISICAL_AUTH_SECRET must be set}"
      SITE_URL: ${INFISICAL_SITE_URL:-http://localhost:3001}
      TELEMETRY_ENABLED: "false"
    depends_on:
      arc_postgres:
        condition: service_healthy
      arc_redis:
        condition: service_healthy
    ports:
      - "3001:8080"
    networks:
      - arc_net
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/status"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 120s
    labels:
      - "arc.service.layer=core"
      - "arc.service.category=secrets"

  # ===========================================================================
  # FEATURE MANAGEMENT - Unleash
  # ===========================================================================
  arc_unleash:
    <<: *medium-service
    image: unleashorg/unleash-server:7.0.6
    container_name: arc_unleash
    restart: unless-stopped
    environment:
      DATABASE_URL: "postgres://${POSTGRES_USER:-arc}:${POSTGRES_PASSWORD:?Error: POSTGRES_PASSWORD must be set}@arc_postgres:5432/${POSTGRES_DB:-arc_db}?sslmode=disable"
      DATABASE_SSL: "false"
      LOG_LEVEL: info
    depends_on:
      arc_postgres:
        condition: service_healthy
    ports:
      - "4242:4242"
    networks:
      - arc_net
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4242/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    labels:
      - "arc.service.layer=core"
      - "arc.service.category=feature-management"
