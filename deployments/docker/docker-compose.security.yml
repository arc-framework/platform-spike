# A.R.C. Framework - Security Plugins
# ==============================================================================
# Optional security services for identity, authentication, and authorization
# These services can be swapped with alternatives
# ==============================================================================

# Shared logging configuration
x-logging: &default-logging
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"
      labels: "arc.service"

# Shared resource limits for medium services
x-resources-medium: &resources-medium
  deploy:
    resources:
      limits:
        cpus: '1.0'
        memory: 1G
      reservations:
        cpus: '0.25'
        memory: 256M

# Combined template
x-medium-service: &medium-service
  <<: *default-logging
  deploy:
    resources:
      limits:
        cpus: '1.0'
        memory: 1G
      reservations:
        cpus: '0.25'
        memory: 256M

services:
  # ===========================================================================
  # IDENTITY & AUTHENTICATION - Ory Kratos
  # ===========================================================================
  arc-jarvis:
    <<: *medium-service
    image: ghcr.io/arc-framework/arc-jarvis-identity:latest
    container_name: arc-jarvis-identity
    hostname: arc-jarvis
    restart: unless-stopped
    command: serve -c /etc/config/kratos/kratos.yml --dev --watch-courier
    environment:
      DSN: "postgres://${POSTGRES_USER:-arc}:${POSTGRES_PASSWORD:?Error: POSTGRES_PASSWORD must be set}@arc-oracle:5432/${POSTGRES_DB:-arc_db}?sslmode=disable&max_conns=20&max_idle_conns=4"
      LOG_LEVEL: info
      SERVE_PUBLIC_BASE_URL: http://localhost:4433/
      SERVE_ADMIN_BASE_URL: http://localhost:4434/
      KRATOS_SECRET_COOKIE: "${KRATOS_SECRET_COOKIE:?Error: KRATOS_SECRET_COOKIE must be set - use 'openssl rand -base64 32'}"
      KRATOS_SECRET_CIPHER: "${KRATOS_SECRET_CIPHER:?Error: KRATOS_SECRET_CIPHER must be set - use 'openssl rand -base64 32'}"
    volumes:
      - ../../plugins/security/identity/kratos:/etc/config/kratos:ro
    ports:
      - "4433:4433"  # Public API
      - "4434:4434"  # Admin API
    networks:
      arc_net:
        aliases:
          - kratos
          - arc-kratos
          - arc_kratos
    depends_on:
      arc-oracle:
        condition: service_healthy
      arc-heimdall:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4434/health/alive"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    labels:
      - "arc.service.layer=plugin"
      - "arc.service.category=security"
      - "arc.service.subcategory=identity"
      - "arc.service.codename=jarvis"
      - "arc.service.role=The Butler"
      - "arc.service.tech=kratos"
      - "arc.service.swappable=true"
      - "arc.service.alternatives=keycloak,auth0,cognito,okta"

  # ===========================================================================
  # AUTHORIZATION - Ory Keto (Optional - not yet configured)
  # ===========================================================================
  # arc_keto:
  #   image: oryd/keto:v0.11.1
  #   container_name: arc_keto
  #   restart: unless-stopped
  #   environment:
  #     DSN: postgres://${POSTGRES_USER:-arc}:${POSTGRES_PASSWORD:-postgres}@arc_postgres:5432/${POSTGRES_DB:-arc_db}?sslmode=disable
  #   ports:
  #     - "4466:4466"  # Read API
  #     - "4467:4467"  # Write API
  #   networks:
  #     - arc_net
  #   depends_on:
  #     arc_postgres:
  #       condition: service_healthy
  #   labels:
  #     - "arc.service.layer=plugin"
  #     - "arc.service.category=security"
  #     - "arc.service.subcategory=authorization"
  #     - "arc.service.swappable=true"
  #     - "arc.service.alternatives=opa,casbin,authz"


