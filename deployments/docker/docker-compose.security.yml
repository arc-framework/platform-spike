# A.R.C. Framework - Security Plugins
# ==============================================================================
# Optional security services for identity, authentication, and authorization
# These services can be swapped with alternatives
# ==============================================================================


services:
  # ===========================================================================
  # IDENTITY & AUTHENTICATION - Ory Kratos
  # ===========================================================================
  arc_kratos:
    image: oryd/kratos:v1.0.0
    container_name: arc_kratos
    restart: unless-stopped
    command: serve -c /etc/config/kratos/kratos.yml --dev --watch-courier
    environment:
      DSN: postgres://${POSTGRES_USER:-arc}:${POSTGRES_PASSWORD:-postgres}@arc_postgres:5432/${POSTGRES_DB:-arc_db}?sslmode=disable&max_conns=20&max_idle_conns=4
      LOG_LEVEL: info
      SERVE_PUBLIC_BASE_URL: http://localhost:4433/
      SERVE_ADMIN_BASE_URL: http://localhost:4434/
    volumes:
      - ../../plugins/security/identity/kratos:/etc/config/kratos:ro
    ports:
      - "4433:4433"  # Public API
      - "4434:4434"  # Admin API
    networks:
      - arc_net
    depends_on:
      arc_postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4434/health/alive"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    labels:
      - "arc.service.layer=plugin"
      - "arc.service.category=security"
      - "arc.service.subcategory=identity"
      - "arc.service.swappable=true"
      - "arc.service.alternatives=keycloak,auth0,cognito,okta"

  # ===========================================================================
  # AUTHORIZATION - Ory Keto (Optional - not yet configured)
  # ===========================================================================
  # arc_keto:
  #   image: oryd/keto:v0.11.1
  #   container_name: arc_keto
  #   restart: unless-stopped
  #   environment:
  #     DSN: postgres://${POSTGRES_USER:-arc}:${POSTGRES_PASSWORD:-postgres}@arc_postgres:5432/${POSTGRES_DB:-arc_db}?sslmode=disable
  #   ports:
  #     - "4466:4466"  # Read API
  #     - "4467:4467"  # Write API
  #   networks:
  #     - arc_net
  #   depends_on:
  #     arc_postgres:
  #       condition: service_healthy
  #   labels:
  #     - "arc.service.layer=plugin"
  #     - "arc.service.category=security"
  #     - "arc.service.subcategory=authorization"
  #     - "arc.service.swappable=true"
  #     - "arc.service.alternatives=opa,casbin,authz"


